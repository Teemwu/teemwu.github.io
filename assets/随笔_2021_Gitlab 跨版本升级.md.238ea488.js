import{_ as p,c,b as l,w as o,d as n,e as r,a as d,r as g,o as b,f as h}from"./app.978116b9.js";const v=JSON.parse('{"title":"Gitlab 跨版本升级","description":"","frontmatter":{"title":"Gitlab 跨版本升级","author":"teemwu","date":"2021/02/26 16:17","isPublished":true,"categories":null,"tags":["gitlab"],"wordCount":1271},"headers":[{"level":1,"title":"Gitlab 跨版本升级","slug":"gitlab-跨版本升级","link":"#gitlab-跨版本升级","children":[{"level":3,"title":"介绍","slug":"介绍","link":"#介绍","children":[]},{"level":3,"title":"开始","slug":"开始","link":"#开始","children":[]},{"level":3,"title":"系统&环境","slug":"系统-环境","link":"#系统-环境","children":[]},{"level":3,"title":"下载&安装","slug":"下载-安装","link":"#下载-安装","children":[]},{"level":3,"title":"自动&定时备份","slug":"自动-定时备份","link":"#自动-定时备份","children":[]},{"level":3,"title":"参考","slug":"参考","link":"#参考","children":[]}]}],"relativePath":"随笔/2021/Gitlab 跨版本升级.md","lastUpdated":1674988227000}'),u={name:"随笔/2021/Gitlab 跨版本升级.md"},y=n("h1",{id:"gitlab-跨版本升级",tabindex:"-1"},[r("Gitlab 跨版本升级 "),n("a",{class:"header-anchor",href:"#gitlab-跨版本升级","aria-hidden":"true"},"#")],-1),C=d(`<h3 id="介绍" tabindex="-1">介绍 <a class="header-anchor" href="#介绍" aria-hidden="true">#</a></h3><p>由于想使用 gitlab 新版本添加的一些特性，最近项目不是很忙，故开始了作死的 gitlab 升级之旅。。。真的，没事还是不建议升级这东西！很久没弄 gitlab 很多东西都忘了，过程中各种踩坑，故写一篇文章记录下升级、安装及配置的过程，希望对各位看官有点帮助。</p><h3 id="开始" tabindex="-1">开始 <a class="header-anchor" href="#开始" aria-hidden="true">#</a></h3><p>一般升级某个软件直接去 <a href="https://about.gitlab.com/update" target="_blank" rel="noreferrer">官网</a> 看更新教程即可，而其官网提示 CentOS 7 升级 gitlab 也很简单，就两步：</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 备份</span></span>
<span class="line"><span style="color:#A6ACCD;">sudo gitlab-rake gitlab:backup:create </span><span style="color:#F07178;">STRATEGY</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">copy</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 下载&amp;安装更新</span></span>
<span class="line"><span style="color:#A6ACCD;">sudo yum install -y gitlab-ce</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>一时兴起，执行完第二步后发现，升级失败，原因是我的 gitlab 版本过老（11.11.3），不能直接升级到 13.x 的版本，需要一个版本一个版本升，参考别人的踩坑经验，选择了 <code>11.11.3 -&gt; 12.0.12 -&gt; 12.10.14 -&gt; 13.0.10 -&gt; 13.4.2 -&gt; 13.9.1</code> 这个版本升级路线 开始尝试升级时，通过 <code>curl</code> 和 <code>yum</code> 的方式在服务器端进行 gitlab-ce 下载，然而经常会因为网络问题中断掉，换了国内镜像源(清华源、阿里云)依旧偶尔中断，第一次更新，通过 <code>yum</code> 进行下载，到百分之九十多的时候进度条卡住了，继续执行安装操作，后面启动时报错(“STDOUT: WARNING: This version of GitLab depends on gitlab-shell 9.3.0, but you&#39;re running 9.1.0. Please update gitlab-shell.”)，找了一晚上的处理方法，各种尝试无果，估计是下载不完全强行安装造成的某些包不对应，或者是之前手动改了一些配置文件导致的，后另起服务器重新安装备份文件的对应版本 11.11.3 重新进行更新操作</p><h3 id="系统-环境" tabindex="-1">系统&amp;环境 <a class="header-anchor" href="#系统-环境" aria-hidden="true">#</a></h3><ul><li>CentOS 7</li><li>Gitlab-CE 11.11.3 -&gt; 12.0.12 -&gt; 12.10.14 -&gt; 13.0.10 -&gt; 13.4.2 -&gt; 13.9.1</li></ul><h3 id="下载-安装" tabindex="-1">下载&amp;安装 <a class="header-anchor" href="#下载-安装" aria-hidden="true">#</a></h3><p>由于国内原因，如果你想通过修改镜像源来下载安装 gitlab-ce 的安装包，可以查看文末的“参考”链接，我不推荐这种做法，因为国内镜像源不稳定，如清华源下载到500M左右就很不稳定，且有些同步不及时。我的做法是，在电脑本地开 VPN 去 <a href="https://packages.gitlab.com/gitlab/gitlab-ce" target="_blank" rel="noreferrer">官网下载</a> 完所有文件后，再上传到服务器上进行安装</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 上传本地文件到指定服务器</span></span>
<span class="line"><span style="color:#A6ACCD;">scp /path/filename username@servername:/path</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>上传到服务器之后，需要先备份且停掉 gitlab 再进行安装</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 创建备份</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab-rake gitlab:backup:create</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 停止 gitlab 各项服务</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab-ctl stop unicorn</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab-ctl stop sidekiq</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab-ctl stop nginx</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 安装指定版本 gitlab</span></span>
<span class="line"><span style="color:#A6ACCD;">rpm -Uvh gitlab-ce-12.0.12-ce.0.el7.x86_64.rpm</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 刷新配置</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab-ctl reconfigure</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 重启 gitlab</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab-ctl restart</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>重复以上几条命令，即可升级到最新版本，如果过程中有红字提示“Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data...&quot;可以暂时不管，升级到最新版本后再处理，报错原因是 gitlab.rb 和 gitlab-secrets.json 两个文件包含敏感信息。未被备份到备份文件中。需要手动备份，两文件路径分别为 <code>/etc/gitlab/gitlab.rb</code> 和 <code>/etc/gitlab/gitlab-secrets.json</code>，如果需要使用旧版本的配置，将老版本的 gitlab.rb 文件替换新版本的 gitlab.rb 即可，gitlab-secrets.json 文件同理，不过这个是记录了安全相关的，比如你访问 Runners 页面提示 500 报错，就需要将旧版本替换掉新版</p><h3 id="自动-定时备份" tabindex="-1">自动&amp;定时备份 <a class="header-anchor" href="#自动-定时备份" aria-hidden="true">#</a></h3><p>修改 <code>/etc/gitlab/gitlab.rb</code> 文件</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 设置备份存储位置</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab_rails[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">backup_path</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">] = </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/mnt/udisk/gitlab/backups</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 备份最近七天的数据，即 7*24*60*60 秒</span></span>
<span class="line"><span style="color:#A6ACCD;">gitlab_rails[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">backup_keep_time</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">] = 604800</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>保存后，刷新配置文件</p><div class="language-bat"><button title="Copy Code" class="copy"></button><span class="lang">bat</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">gitlab-ctl reconfigure</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>编辑定时任务</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">crontab -e</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>加入以下内容后保存(每天中午 12 点和傍晚 18 点自动执行备份操作)</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">0 12 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create</span></span>
<span class="line"><span style="color:#A6ACCD;">0 18 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>保存后我们需要重新启动定时器，执行如下语句</p><div class="language-ini"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 重启定时任务</span></span>
<span class="line"><span style="color:#A6ACCD;">systemctl restart crond.service</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 重装定时任务</span></span>
<span class="line"><span style="color:#A6ACCD;">systemctl reload crond.service</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 查看定时任务是否开启（可选）</span></span>
<span class="line"><span style="color:#A6ACCD;">systemctl is-enabled crond.service</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 查看所有用户下的定时任务（可选）</span></span>
<span class="line"><span style="color:#A6ACCD;">cat /etc/passwd | cut -f 1 -d : |xargs -I {} crontab -l -u {}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>至此，自动定时备份完成</p><h3 id="参考" tabindex="-1">参考 <a class="header-anchor" href="#参考" aria-hidden="true">#</a></h3><ul><li><a href="https://blog.csdn.net/djzhao627/article/details/88356067" target="_blank" rel="noreferrer">CentOS 7下安装指定版本的GitLab，和数据备份与恢复</a></li><li><a href="https://blog.csdn.net/huoyan98/article/details/108917811" target="_blank" rel="noreferrer">gitlab从11.11.3升级至13.4.2</a></li><li><a href="https://www.cnblogs.com/jxd283465/p/11525629.html" target="_blank" rel="noreferrer">gitlab安装、备份、恢复、升级、内存消耗问题</a></li><li><a href="https://www.codenong.com/cs106080856/" target="_blank" rel="noreferrer">curl命令断点续传多线程下载文件</a></li><li><a href="https://blog.csdn.net/fishinhouse/article/details/105131917" target="_blank" rel="noreferrer">访问Gitlab中的runners页面时显示500问题</a></li><li><a href="https://www.cnblogs.com/sxdcgaq8080/p/10730633.html" target="_blank" rel="noreferrer">【linux】【tomcat】linux下定时重启tomcat 【CentOS 6.4】【CentOS 7.6】</a></li></ul>`,28);function m(a,s,A,f,_,D){const e=h,t=g("ClientOnly");return b(),c("div",null,[y,l(t,null,{default:o(()=>[l(e,{modelValue:a.$frontmatter,"onUpdate:modelValue":s[0]||(s[0]=i=>a.$frontmatter=i)},null,8,["modelValue"])]),_:1}),C])}const E=p(u,[["render",m]]);export{v as __pageData,E as default};
